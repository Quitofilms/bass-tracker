<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bass Tone Tracker</title>
    <style>
        body {
            background-color: #000;
            color: white;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background-color: #333; /* Default OFF color */
            transition: background-color 0.1s ease;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        #hz-display {
            margin-top: 40px;
            font-size: 48px;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        #note-display {
            font-size: 24px;
            color: #888;
            margin-top: 10px;
        }

        #start-btn {
            position: absolute;
            z-index: 10;
            padding: 20px 40px;
            font-size: 24px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }

        #status {
            position: absolute;
            bottom: 20px;
            font-size: 14px;
            color: #888;
            text-align: center;
            width: 90%;
            word-wrap: break-word;
        }

        /* Bass Profile Legend */
        .legend {
            position: absolute;
            top: 20px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="legend">
        BASS PROFILE<br>
        Green: < D3 (146Hz)<br>
        Red: > D#3 (155Hz)
    </div>

    <button id="start-btn">Start Bass Tracker</button>
    
    <div id="circle"></div>
    <div id="hz-display">-- Hz</div>
    <div id="note-display">Silence</div>
    <div id="status">Ready</div>

    <script>
        // --- CONFIGURATION FOR BASS SINGER ---
        const THRESHOLD_YELLOW = 145; // Approx D3
        const THRESHOLD_RED = 154;    // Approx D#3
        
        let audioContext;
        let analyser;
        let microphone;
        let animationId;
        
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        const startBtn = document.getElementById('start-btn');
        const circle = document.getElementById('circle');
        const hzDisplay = document.getElementById('hz-display');
        const noteDisplay = document.getElementById('note-display');
        const statusDisplay = document.getElementById('status');

        // Add a global touch listener to unlock audio on any tap
        document.body.addEventListener('touchstart', function() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { passive: true });

        startBtn.addEventListener('click', async () => {
            // 1. User Interaction has happened. Now we can init Audio.
            statusDisplay.textContent = "Initializing Audio...";
            
            try {
                // Initialize Audio Context inside the click to appease iOS/Android
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // FORCE WAKE UP:
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                startBtn.style.display = 'none';
                
                // Request Wake Lock
                if ('wakeLock' in navigator) {
                    try { await navigator.wakeLock.request('screen'); } catch(err) {}
                }

                await initAudio();

            } catch (e) {
                console.error(e);
                statusDisplay.style.color = "red";
                statusDisplay.textContent = "Error: " + e.message + " (" + e.name + ")";
                startBtn.style.display = 'block';
            }
        });

        async function initAudio() {
            try {
                // Simplified constraints for maximum mobile compatibility
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: false,
                        autoGainControl: false,
                        noiseSuppression: false
                    } 
                });

                statusDisplay.textContent = "Microphone Connected.";

                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                
                // High precision for Bass
                analyser.fftSize = 32768; 
                analyser.smoothingTimeConstant = 0.85;

                microphone.connect(analyser);
                
                // --- MOBILE KEEP-ALIVE HACK ---
                // We play 'silence' to the speakers to keep the audio thread active.
                const forceActiveGain = audioContext.createGain();
                forceActiveGain.gain.value = 0.0001; 
                microphone.connect(forceActiveGain);
                forceActiveGain.connect(audioContext.destination);
                
                statusDisplay.textContent = "Listening...";
                updatePitch();
            } catch (err) {
                throw err; // Pass error up to the button handler
            }
        }

        function updatePitch() {
            // Debug: Check if context died
            if (audioContext && audioContext.state === 'suspended') {
                 audioContext.resume();
            }

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Float32Array(bufferLength);
            analyser.getFloatFrequencyData(dataArray);

            const maxVol = Math.max(...dataArray);
            
            // Show volume for debugging
            if (Math.random() < 0.1) { // Update text less often to save CPU
                statusDisplay.textContent = `Listening... Vol: ${Math.round(maxVol)} dB`;
            }

            // Noise Gate (Adjusted for phone mics) - Lowered to -90dB
            if (maxVol < -90) { 
                updateUI(0, "gray");
                animationId = requestAnimationFrame(updatePitch);
                return;
            }

            const sampleRate = audioContext.sampleRate;
            const resolution = sampleRate / analyser.fftSize;
            
            const minBin = Math.floor(60 / resolution);  // Raised slightly to 60Hz to avoid phone handling noise
            const maxBin = Math.floor(400 / resolution);
            
            let maxHPS = -Infinity;
            let peakBin = -1;

            for (let i = minBin; i < maxBin; i++) {
                let h1 = dataArray[i];             
                let h2 = dataArray[i * 2] || -100; 
                let h3 = dataArray[i * 3] || -100; 
                
                // HPS Logic
                let hpsValue = h1 + (0.8 * h2) + (0.6 * h3);
                
                if (hpsValue > maxHPS) {
                    maxHPS = hpsValue;
                    peakBin = i;
                }
            }

            const fundamentalFreq = peakBin * resolution;
            
            determineColor(fundamentalFreq);
            animationId = requestAnimationFrame(updatePitch);
        }

        function determineColor(freq) {
            // Ignore noise below floor
            if (freq < 60) return; 

            const noteName = getNote(freq);
            hzDisplay.textContent = Math.round(freq) + " Hz";
            noteDisplay.textContent = noteName;

            if (freq < THRESHOLD_YELLOW) {
                circle.style.backgroundColor = "#00ff00"; // Green
                hzDisplay.style.color = "#fff";
            } else if (freq < THRESHOLD_RED) {
                circle.style.backgroundColor = "#ffff00"; // Yellow
                hzDisplay.style.color = "#ffff00";
            } else {
                circle.style.backgroundColor = "#ff0000"; // Red
                hzDisplay.style.color = "#ff0000";
            }
        }

        function updateUI(freq, color) {
            if (freq === 0) {
                circle.style.backgroundColor = "#333";
                hzDisplay.textContent = "-- Hz";
                hzDisplay.style.color = "#555";
                noteDisplay.textContent = "Silence";
            }
        }

        function getNote(freq) {
            const noteNum = 12 * (Math.log(freq / 440) / Math.log(2));
            const noteIndex = Math.round(noteNum) + 69;
            const note = notes[noteIndex % 12];
            const octave = Math.floor(noteIndex / 12) - 1;
            return note + octave;
        }
    </script>
</body>
</html>
